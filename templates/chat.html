{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block content %}
<main class="w-full max-w-6xl mx-auto py-6">
  <section class="w-full border border-white/40 rounded-2xl p-4 sm:p-6 bg-black/40">
    <div id="chat-messages" class="space-y-4 min-h-[420px]"></div>

    <div class="mt-5 w-full pl-3 pr-1 py-1 rounded-3xl border border-gray-200 items-center gap-2 inline-flex justify-between bg-white">
      <button id="chat-new" class="px-3 py-2 rounded-full text-gray-800 text-xs font-semibold hover:bg-gray-300 transition" style="background-color:#ff637e">
        New chat
      </button>
      <input id="chat-input" class="grow shrink basis-0 text-black text-sm font-medium leading-5 focus:outline-none" placeholder="Type here..." autocomplete="off">
      <button id="chat-send" class="items-center flex px-3 py-2 bg-indigo-600 rounded-full shadow">
        <h3 class="text-white text-xs font-semibold leading-4 px-2">Send</h3>
      </button>
    </div>
  </section>
</main>
<script>
  const CHAT_STORAGE_KEY = "vaani_chat_messages_v1";
  const INITIAL_MESSAGE = {
    role: "assistant",
    text: "Hi, I am ready. Ask me anything.",
  };

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return "";
  }

  function renderMessage(role, text) {
    const messages = document.getElementById("chat-messages");
    const row = document.createElement("div");
    row.className = role === "user" ? "flex justify-end" : "flex gap-2.5";

    if (role === "user") {
      row.innerHTML = `
        <div class="max-w-[80%]">
          <p class="text-right text-[#f8fafc] text-sm font-bold">You</p>
          <div class="chat-user-bubble mt-1 px-3.5 py-2 rounded-lg text-white text-sm bg-indigo-600 whitespace-pre-wrap"></div>
        </div>
      `;
      row.querySelector(".chat-user-bubble").textContent = text;
    } else {
      row.innerHTML = `
        <img src="https://pagedone.io/asset/uploads/1710412177.png" alt="Assistant avatar" class="w-10 h-10 rounded-full">
        <div class="max-w-[80%]">
          <p class="text-[#ff637e] text-sm font-bold">Vaani</p>
          <div class="chat-assistant-bubble mt-1 px-3.5 py-2 rounded-lg text-white text-sm whitespace-pre-wrap" style="background-color:#ff637e"></div>
        </div>
      `;
      row.querySelector(".chat-assistant-bubble").textContent = text;
    }

    messages.appendChild(row);
    row.scrollIntoView({ behavior: "smooth", block: "end" });
  }

  function loadMessages() {
    try {
      const raw = localStorage.getItem(CHAT_STORAGE_KEY);
      if (!raw) return [INITIAL_MESSAGE];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed) || parsed.length === 0) return [INITIAL_MESSAGE];
      return parsed.filter(msg => msg && (msg.role === "user" || msg.role === "assistant") && typeof msg.text === "string");
    } catch {
      return [INITIAL_MESSAGE];
    }
  }

  function saveMessages(messages) {
    localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(messages));
  }

  let chatMessages = loadMessages();

  function redrawMessages() {
    const container = document.getElementById("chat-messages");
    container.innerHTML = "";
    chatMessages.forEach(msg => renderMessage(msg.role, msg.text));
  }

  function appendMessage(role, text, persist = true) {
    renderMessage(role, text);
    if (persist) {
      chatMessages.push({ role, text });
      saveMessages(chatMessages);
    }
  }

  function addThinkingMessage() {
    const messages = document.getElementById("chat-messages");
    const row = document.createElement("div");
    row.id = "thinking-row";
    row.className = "flex gap-2.5";
    row.innerHTML = `
      <img src="https://pagedone.io/asset/uploads/1710412177.png" alt="Assistant avatar" class="w-10 h-10 rounded-full">
      <div class="max-w-[80%]">
        <p class="text-[#ff637e] text-sm font-bold">Vaani</p>
        <div class="mt-1 px-3.5 py-2 rounded-lg text-white text-sm whitespace-pre-wrap" style="background-color:#ff637e">VAANI is thinking...</div>
      </div>
    `;
    messages.appendChild(row);
    row.scrollIntoView({ behavior: "smooth", block: "end" });
  }

  function removeThinkingMessage() {
    const row = document.getElementById("thinking-row");
    if (row) row.remove();
  }

  async function sendMessage() {
    const input = document.getElementById("chat-input");
    const button = document.getElementById("chat-send");
    const text = input.value.trim();
    if (!text) return;

    appendMessage("user", text);
    addThinkingMessage();
    input.value = "";
    button.disabled = true;

    try {
      const response = await fetch("{% url 'chat_send' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ message: text }),
      });

      const data = await response.json();
      removeThinkingMessage();
      if (!response.ok) {
        const detail = data.details ? ` ${data.details}` : "";
        appendMessage("assistant", `${data.error || "Something went wrong."}${detail}`);
      } else {
        appendMessage("assistant", data.reply);
      }
    } catch (err) {
      removeThinkingMessage();
      appendMessage("assistant", "Network error. Please try again.");
    } finally {
      removeThinkingMessage();
      button.disabled = false;
      input.focus();
    }
  }

  function startNewChat() {
    removeThinkingMessage();
    chatMessages = [INITIAL_MESSAGE];
    saveMessages(chatMessages);
    redrawMessages();
    document.getElementById("chat-input").focus();
  }

  redrawMessages();
  document.getElementById("chat-send").addEventListener("click", sendMessage);
  document.getElementById("chat-new").addEventListener("click", startNewChat);
  document.getElementById("chat-input").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });
</script>
{% endblock %}
